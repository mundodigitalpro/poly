# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Polymarket trading client and autonomous bot written in Python. The project enables trading on Polymarket via API using the `py-clob-client` library, supporting both Magic Link (email/Gmail) and MetaMask authentication methods.

## Core Architecture

### Authentication Flow

The client uses a two-tier authentication system:

1. **Wallet Authentication**: Private key + optional funder address (for Magic Link users)
2. **API Credentials**: Generated via `generate_user_api_keys.py` using `create_or_derive_api_creds()`

**Critical: Signature Types**
- `signature_type=1`: Magic Link (Gmail/email login) - most common
- `signature_type=0`: EOA wallets (MetaMask, hardware wallets)
- `signature_type=2`: Browser wallet proxy (rarely used)

The signature type is auto-detected in `poly_client.py:74` based on presence of `POLY_FUNDER_ADDRESS`.

### Key Components

1. **poly_client.py**: Main CLI client for market exploration, balance checks, and orderbook monitoring
   - Supports filtering markets (`--filter`), orderbook viewing (`--book`), and real-time monitoring (`--monitor`)
   - Uses `ClobClient` with automatic signature type detection

2. **place_order.py**: Manual order placement script
   - Configure `TOKEN_ID`, `PRICE`, and `SIZE` directly in the file
   - Currently uses `signature_type=2` hardcoded (line 42) - should match your auth method

3. **auto_sell.py**: Automated sell bot with safety protections
   - Implements take-profit/stop-loss monitoring
   - Requires manual confirmation by default (`REQUIRE_CONFIRMATION = True`)
   - Enforces minimum acceptable price (`MIN_ACCEPTABLE`) to prevent panic sells

4. **generate_user_api_keys.py**: Generates or retrieves API credentials
   - Must be run whenever credentials expire or are invalid
   - Derives wallet address for EOA users automatically

### Planned Architecture (Autonomous Bot)

Located in `bot_plan.md` (526 lines, production-ready design), the autonomous bot implements:

**Market Selection** (all filters must pass):
- Odds: 0.30-0.70 (uncertain markets)
- Spread: <5% (critical for small trades)
- Volume: >$100 both sides
- Resolution timeframe: <30 days (avoid capital lockup)
- Weighted scoring algorithm for ranking candidates

**Position Management**:
- Persistent storage via `positions.json`, `blacklist.json`, `stats.json`
- Dynamic TP/SL based on entry odds (8-25% targets)
- Temporal blacklist (3 days, max 2 attempts per market)
- Partial fill handling
- Real balance verification each loop

**Risk Management** (10 protections):
- Capital: $5 safety reserve, $0.25-$1.00 per trade (phased)
- Daily loss limit: $3
- Max 5 concurrent positions
- 5-minute cooldown between trades
- Rate limiting: 20 API calls/min
- Dry run mode for testing

**Stats Tracking**:
- Win rate, profit factor, Sharpe ratio
- P&L by odds range
- Daily dashboard with performance metrics
- Fee tracking (integrated into TP/SL calculations)

**Deployment Phases**:
1. Dry run (7+ days simulation)
2. Paper trading (1 week analysis)
3. Micro trading ($0.25, 20-30 trades)
4. Normal trading ($1.00, gradual scaling)
5. VPS deployment (after 2+ weeks stable)

**Main Loop** (120-300s interval):
1. Load positions + verify balance
2. Scan open positions → execute TP/SL
3. Check if can operate (balance, limits, cooldown)
4. Scan markets → rank by score → select best
5. Execute trade → save position → update stats
6. Repeat

See `bot_plan.md` for complete implementation details including `config.json` structure, logging format, and error handling patterns.

## Environment Setup

```bash
# Install dependencies
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -r requirements.txt

# Configure credentials
cp .env.example .env
# Edit .env with your credentials (see Configuration section)

# Generate API keys
python generate_user_api_keys.py
```

## Configuration

Required environment variables in `.env`:

```bash
# Generated by generate_user_api_keys.py
POLY_API_KEY=...
POLY_API_SECRET=...
POLY_API_PASSPHRASE=...

# Wallet credentials from Polymarket Settings -> Export Private Key
POLY_PRIVATE_KEY=0x...

# Only for Magic Link users (most common)
POLY_FUNDER_ADDRESS=0x...
```

**Note**: If using MetaMask/EOA wallet, omit `POLY_FUNDER_ADDRESS` entirely.

## Common Commands

```bash
# Check account status
python poly_client.py --balance

# List markets with filter
python poly_client.py --filter "Trump" --limit 10

# View orderbook for specific token
python poly_client.py --book <TOKEN_ID>

# Monitor orderbook in real-time
python poly_client.py --book <TOKEN_ID> --monitor --interval 5

# Place order (edit file first)
python place_order.py

# Run auto-sell bot (edit configuration first)
python auto_sell.py

# Regenerate API credentials
python generate_user_api_keys.py

# Verify configuration
python verify_wallet.py
python diagnose_config.py
```

## Docker Deployment

```bash
docker-compose up --build -d
docker-compose logs -f
```

## Critical Implementation Details

1. **Signature Type Consistency**: When modifying authentication code, ensure `signature_type` matches the wallet type throughout. The client auto-detects in `poly_client.py` but some scripts like `place_order.py` have it hardcoded.

2. **API Credential Lifecycle**: User API credentials are derived from the private key via the CLOB API. They may expire or become invalid, requiring regeneration with `generate_user_api_keys.py`.

3. **Funder vs Key Parameter**:
   - Magic Link: `funder=POLY_FUNDER_ADDRESS`, `key=POLY_PRIVATE_KEY`
   - MetaMask: `funder=derived_address`, `key=POLY_PRIVATE_KEY`
   - See `generate_user_api_keys.py:42-50` for the pattern

4. **Order Execution**: Uses `create_and_post_order()` with `OrderArgs` and `PartialCreateOrderOptions`. The tick size is typically `"0.01"` for Polymarket markets.

5. **Orderbook Parsing**: The SDK returns objects with `.bids` and `.asks` attributes. Some markets may return empty lists. Always check with `getattr(book, 'bids', [])` pattern (see `poly_client.py:133-158`).

## Troubleshooting Patterns

- **401 Unauthorized**: Run `python generate_user_api_keys.py`
- **Invalid Signature**: Verify signature_type matches your authentication method (Magic Link = 1, MetaMask = 0)
- **Insufficient Balance**: Check wallet on PolygonScan or Polymarket portfolio
- **Empty Orderbook**: Market may have no liquidity; try a different token_id

## Security Considerations

- Never commit `.env` file (already in `.gitignore`)
- Private keys grant full access to wallet funds
- Bot operates on Polygon mainnet with real money
- Always test with small amounts first
